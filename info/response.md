# 自动更新导致格式丢失问题的深度修复

## 问题分析

你反馈的两个现象揭示了同一个核心问题：**配置数据在传输或保存过程中丢失了。**

1.  **现象一：修改标题 -> 变成纯文本引用 (Ref without format)**
    *   **原因**：当插件读取大纲块的配置时，`outlineType` 字段可能为 `undefined`（丢失）。
    *   **后果**：代码中的 `if (outlineType == "copy")` 为假，`else if (outlineType == "ref")` 也为假（因为 undefined 不等于字符串）。代码被迫进入最后的 `else` 分支，生成了默认的块引用格式 `((id 'text'))`。这种格式会把标题放入锚文本中，导致富文本格式丢失。

2.  **现象二：修改列表 -> 变成链接 (Link format)**
    *   **原因**：这可能是因为配置丢失后，代码回退到了默认值 `"ref"`。
    *   **后果**：`outlineType` 被识别为 `"ref"`，导致生成 `[text](siyuan://...)` 链接格式。

**根本原因**：之前修复的 `loadSettings` vs `loadSettingsforOutline` 问题虽然解决了*读取*逻辑，但如果之前产生的区块属性本身已经因为 Bug 而损坏（缺少 `outlineType` 字段），那么读取出来的就是 `undefined`。且之前的代码在读取到 `undefined` 时，会错误地将全局设置也更新为 `undefined`，并再次保存回区块，导致“数据损坏”被持久化。

## 已执行的修复

### 1. 防御性配置加载 (`src/settings.ts`)
我修改了 `loadSettings` 和 `loadSettingsforOutline` 函数。现在，如果从区块中读取到的配置缺少某些字段（如 `outlineType`），插件**不再会将其设为 undefined**，而是会自动使用默认值填补。
*   这防止了“纯文本引用” (undefined) 的情况再次发生。
*   它保证了插件内部状态的稳定性。

### 2. 增加调试日志 (`src/creater/createIndex.ts`)
我在自动更新逻辑中增加了详细的 `console.log`。如果问题依然存在，你可以按 `F12` 打开控制台，搜索 `[IndexPlugin]`，查看：
*   `Raw IAL String`: 区块中实际保存的 JSON 字符串是什么。
*   `Parsed Settings`: 解析出来的对象是否包含 `outlineType`。
*   `Applied 'outlineType'`: 最终应用到插件内存中的值是 `"copy"` 还是 `"ref"`。

## 建议操作

由于旧的大纲块可能保存了错误的（或缺失的）配置数据：

1.  **删除旧大纲**：请将那个表现异常的大纲块（以及整个列表）删除。
2.  **确认设置**：在设置面板中确认“大纲类型”已选为 **“复制” (Copy)**。
3.  **重新插入**：重新插入一次大纲。此时，正确的配置 (`outlineType: "copy"`) 将被写入新块的属性中。
4.  **测试**：尝试修改标题，观察自动更新是否正常保留了格式。

这次修复后，即使读取到损坏的数据，也会回退到安全默认值（通常是链接模式），而不会再出现未定义的怪异行为。重新插入新块应能彻底解决问题。
